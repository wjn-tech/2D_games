# OpenSpec: 魔法与敌人系统扩展

## 1. 提案摘要
本提案旨在扩展游戏的核心魔法系统与敌人种类，引入物理毁伤（爆炸）、环境交互（黑洞）、空间位移（传送）以及逻辑执行链（顺序释放）。同时，通过丰富敌人物种掉落，强化“击败特定敌人获取特定法术”的驱动力。

## 2. 核心架构变更

### 2.1 魔法系统 (Spell System)
- **新指令类型 (`SpellInstruction`)**:
    - `TYPE_RELAY_SEQUENCE`: 顺序继电器。
    - `TYPE_PROJECTILE_SPECIAL`: 特殊投射物（爆炸、黑洞、传送）。
- **投射物扩展 (`ProjectileBase`)**:
    - 引入 `behavior` 属性，用于区分 `tnt`, `blackhole`, `teleport`。
    - 增加 `_process_behavior` 钩子处理持续性逻辑。

### 2.2 环境交互 (World Interaction)
- **DiggingManager 扩展**:
    - 新增 `explode_at(position, radius)`: 实现半径内方块批量销毁并转为掉落物。
    - 新增 `dissolve_at(position, radius)`: 为黑洞设计的静默消融接口。

### 2.3 敌人与掉落 (NPCs & Loot)
- **掉落库强化**: 在 `BaseNPC` 中建立更完善的 `Display Name -> Loot` 映射表。

## 3. 详细设计

### 3.1 新增法术规格
| 法术名称 | 类型 | 效果描述 | 视觉效果 |
| :--- | :--- | :--- | :--- |
| **TNT** | 特殊弹 | 碰到障碍物或时间结束爆炸，半径 48px 内方块销毁并掉落，生物受 30 伤害。 | 红色方格，引信冒烟。爆炸产生剧烈白光及像素烟尘。 |
| **黑洞** | 特殊弹 | 极慢移动（50px/s），周围 32px 方块持续消融，吸引附近生物。 | 黑色空洞，中心带发光吸积盘，扭曲背景感。 |
| **传送弹** | 特殊弹 | 消失时将玩家 `global_position` 设置为弹药位置。 | 紫色粒子流，消失时产生闪烁效果。 |
| **顺序释放** | 继电器 | 连接 1-3 个子路，每隔 0.2s 激活一个。 | 灰色芯片，带编号输出端口。 |
| **延迟/速度修正** | 修正案 | 调整 `spell_cooldown` 或投射物 `speed`。 | 对应颜色光晕特效。 |

### 3.2 敌人掉落适配
- **公主 (Princess)**: 必掉延时/顺序继电器（智力象征）。
- **爆炸史莱姆 (Boom Slime)**: (新) 掉落 TNT。
- **恶魔之眼 (Demon Eye)**: 掉落速度修正。
- **虚空游猎者 (Void Hunter)**: (新) 掉落黑洞、位移弹。

## 4. 实施计划 (Todos)
1. [ ] **数据层**: 在 `WandData` 和编译器中支持多个输出端口。
2. [ ] **世界交互**: 在 `DiggingManager.gd` 实现 `explode_at` 和 `dissolve_at`。
3. [ ] **投射物**: 在 `projectile_base.gd` 实现爆炸逻辑和黑洞持续碰撞检查。
4. [ ] **UI**: 为“顺序释放”单元适配多端口 GraphNode。
5. [ ] **视觉**: 编写简单的着色器 (Shader) 处理黑洞扭曲和爆炸辉光。

## 5. 局限性与备注
- 爆炸造成的方块掉落物数量需设上限，防止性能崩溃。
- 黑洞移动慢，需要检测是否卡入实心墙导致卡顿。
