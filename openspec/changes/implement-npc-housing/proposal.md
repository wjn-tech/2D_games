# Proposal: NPC Housing and Settlement System

## Motivation
为了提升游戏的长期可玩性与世界生动感，需要实现一套类似泰拉瑞亚的 NPC 住房与城镇建设系统。该系统允许玩家通过建筑行为吸引 NPC 入住，并形成具有功能的聚落（Settlement）。

## Problem Statement
当前项目缺乏自动化房屋判定机制，NPC 的生成与迁入逻辑较为死板且缺乏反馈。玩家建造的结构仅具有物理阻挡作用，无法转化为具有社会功能的“家”。

## Proposed Changes
1. **房屋自动化检测**：实现基于泛洪填充（Flood Fill）的房屋判定算法，限定在单个区块（64x64）内。
2. **NPC 智能迁入逻辑**：游荡 NPC 自动寻找并入住合格房屋，建立所有权。
3. **快乐度与晶塔系统**：根据环境与邻居关系影响 NPC 快乐度，解锁晶塔传送点。
4. **增强型摆放系统**：
    *   实现 `TileItemData` 以支持背景墙（Layer 2）自动切换。
    *   支持连续拖拽摆放、距离限制（Reach Distance）及智能对齐。
    *   提供基于颜色反馈（绿/红）的摆放预览。
5. **拆除与恢复工具**：引入“锤子”类工具专门处理背景墙，挖掘背景墙将产生掉落物。
6. **房屋检查模式**：提供 UI 工具供玩家检查房屋是否合格。
7. **NPC 轮回机制**：非子嗣 NPC 死亡后会重生成新个体。

## Architectural Impact
- **SettlementManager**：将从简单的建筑注册机演变为核心的聚落逻辑控制器。
- **InfiniteChunkManager**：需要配合房屋检测提供瓦片数据查询。
- **CharacterData / BaseNPC**：增加住房状态与社交偏好字段。
- **UI**：新增房屋检查工具界面。

## User Experience
玩家建造封闭空间（包含背景墙、光源、桌椅、门）后，使用检查工具可确认房屋是否有效。有效后，附近的游荡 NPC 或满足条件的 NPC 会在夜晚或离开屏幕时自动入住，房屋内出现其旗号。

## Risk Assessment
- **性能风险**：大规模区块扫描可能导致卡顿。通过限制单区块检测与按需触发来缓解。
- **逻辑冲突**：无限地图导致 NPC 远离玩家时可能被卸载。需要持久化 NPC 的住房坐标。
